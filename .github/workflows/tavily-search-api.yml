name: Tavily Search API Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: "Select tests to run"
        required: true
        type: choice
        options:
          - All Test cases
          - Positive test cases
          - Negative test cases
          - Edge test cases
      parallel:
        description: "Run tests in parallel?"
        required: true
        type: choice
        options:
          - No (default)
          - Yes (run in parallel)

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y default-jre
          npm i -g allure-commandline --no-fund --no-audit

      - name: Show installed packages
        run: |
          pip list
          python -c "import tavily; print('tavily-python version:', getattr(tavily, '__version__', 'unknown'))"

      - name: Check API key is present
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          python -c "import os; k=os.getenv('TAVILY_API_KEY'); print('Has TAVILY_API_KEY:', bool(k)); assert k, 'TAVILY_API_KEY missing in CI (set repo secret TAVILY_API_KEY)'"

      - name: Run tests (with selected marker)
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          echo "Selected suite: ${{ github.event.inputs.test_suite }}"
          echo "Parallel mode: ${{ github.event.inputs.parallel }}"
          MARKER=""
          case "${{ github.event.inputs.test_suite }}" in
            "Positive test cases") MARKER="-m positive" ;;
            "Negative test cases") MARKER="-m negative" ;;
            "Edge test cases")     MARKER="-m edge" ;;
            *) MARKER="" ;;  # All Test cases
          esac
          PARALLEL_FLAG=""
          case "${{ github.event.inputs.parallel }}" in
            "Yes (run in parallel)") PARALLEL_FLAG="-n auto" ;;  
            *) PARALLEL_FLAG="" ;;
          esac
          # Re-run failing tests up to 2 times, 3s delay
          pytest $MARKER $PARALLEL_FLAG --alluredir=allure-results --clean-alluredir -q --reruns 2 --reruns-delay 3

      - name: Generate Allure HTML report
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean

      - name: List report contents (debug)
        if: always()
        run: |
          echo "=== allure-report ==="
          ls -lah allure-report
          echo "=== allure-report/data ==="
          ls -lah allure-report/data || true

      - name: Upload Allure results (raw)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
          retention-days: 30

      - name: Upload Allure report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          retention-days: 30

      - name: Configure GitHub Pages
        if: always()
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./allure-report

  deploy-pages:
    needs: tests
    if: always()
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
